(function(K,d,L){function g(a,c,b,d){this.path=a;this.files=null!=c?c instanceof Array?c:[c]:[];this.flag="boolean"===typeof b?b:!1;this.toPath=d}function q(a){var c=[];if(a instanceof Array)for(var b=0;b<a.length;b++)c.push(a[b].name);else c.push(a.name);return c}function y(a){var c=d("<div class='spinner'><i class='fa fa-spinner fa-pulse fa-3x fa-fw'></i><span class='sr-only'>"+e.loading+"</span></div>"),b=a.outerHeight();0==b&&a.children().each(function(){var a=d(this).outerHeight();a>b&&(b=a)});
c.find("i").css("margin-top",b/2-20+"px");c.height(b);c.width(a.width());c.prependTo(a);return c}function M(a,c){var b="",e=y(m);a.data&&null!=a.data.path&&(b=a.data.path);var t=x.format("Folders"),E=new g(b);d.ajax({type:"GET",url:t,dataType:"json",data:E,context:this,beforeSend:v.setModuleHeaders}).done(function(t,d,E){null!=t&&c.call(this,t,a.node);""==b&&(t=this.rootContainer.find(".ui-treenode-parent:first"),this.selectNode(t))}).fail(function(a,c,b){k(b,a.responseText)}).complete(function(){e.remove()})}
function N(a){var c=y(f),b=x.format("Files");a=new g(a,null,F);d.ajax({type:"GET",url:b,dataType:"json",data:a,context:this,beforeSend:v.setModuleHeaders}).done(function(a,c,b){f.puidatatable("option","datasource",a);C&&(G&&f.find(".ui-column-filter").each(function(){d(this).val("")}),f.puidatatable("filter"))}).fail(function(a,c,b){k(b,a.responseText)}).complete(function(){c.remove()})}function z(a,c){return d.ajax({type:"GET",url:x.format(a),dataType:"json",data:c,beforeSend:v.setModuleHeaders})}
function p(a,c){return d.ajax({type:"POST",url:x.format(a),dataType:"json",data:c,beforeSend:v.setModuleHeaders})}function O(a,c){return"{0} {1}".format(a.icon,a.name)}function P(a,c){var b=a.size;if(0==b)return lr.ZeroByte;var d=parseInt(Math.floor(Math.log(b)/Math.log(1024)));return Math.round(b/Math.pow(1024,d),2)+" "+H[d]}function Q(a){a=new Date(a.modified);return a.toLocaleDateString()+" "+a.toLocaleTimeString()}function k(a,c){var b="{0}: {1}".format(a,c);D.text(b);A.dialog("open")}function I(a,
c){var b=d.Deferred();d("<div></div>").html(a).dialog({modal:!0,minWidth:350,title:e.confirmTitle,dialogClass:"dnnFormPopup",buttons:[{text:e.dialogOk,click:function(){b.resolve(c);d(this).dialog("close")}},{text:e.dialogCancel,click:function(){b.reject();d(this).dialog("close")}}],close:function(){d(this).dialog("destroy").remove()}});return b.promise()}function B(a,c){var b=d.Deferred();d("<div><label for='txtItemName'>"+e.itemName+"&nbsp;</label><input type='text' name='txtItemName' id='txtItemName' class='ui-inputtext ui-widget-content ui-corner-all' value='"+
c+"'></div>").dialog({modal:!0,minWidth:350,title:a,dialogClass:"dnnFormPopup",buttons:[{text:e.dialogOk,click:function(){var a=d(this).find("#txtItemName").val().trim();""!=a?b.resolve(a):b.reject();d(this).dialog("close")}},{text:e.dialogCancel,click:function(){b.reject();d(this).dialog("close")}}],close:function(){d(this).dialog("destroy").remove()}});return b.promise()}function R(){var a=[];w&&(a.push("<li><a id='{0}' data-icon='{1}'>{2}</a></li>".format("cmfSelectAll","fa-hand-lizard-o",e.itemSelectAll)),
a.push("<li><a id='{0}' data-icon='{1}'>{2}</a></li>".format("cmfCut","fa-scissors",e.itemCut)),a.push("<li><a id='{0}' data-icon='{1}'>{2}</a></li>".format("cmfCopy","fa-copy",e.itemCopy)),a.push("<li><a id='{0}' data-icon='{1}'>{2}</a></li>".format("cmfPaste","fa-paste",e.itemPaste)),a.push("<li><a id='{0}' data-icon='{1}'>{2}</a></li>".format("cmfRename","fa-edit",e.itemRename)),a.push("<li><a id='{0}' data-icon='{1}'>{2}</a></li>".format("cmfDelete","fa-trash",e.itemDelete)));a.push("<li><a id='{0}' data-icon='{1}'>{2}</a></li>".format("cmfOpen",
"fa-external-link",e.fileOpen));a.push("<li><a id='{0}' data-icon='{1}'>{2}</a></li>".format("cmfDownload","fa-download",e.fileDownload));a.push("<li><a id='{0}' data-icon='{1}'>{2}</a></li>".format("cmfClipboard","fa-link",e.fileClipboard));w&&(a.push("<li><a id='{0}' data-icon='{1}'>{2}</a></li>".format("cmfPack","fa-compress",e.filePack)),a.push("<li><a id='{0}' data-icon='{1}'>{2}</a></li>".format("cmfUnpack","fa-expand",e.fileUnpack)));h.append(a);h.on("click","li a",S);h.puicontextmenu({target:f})}
function T(a){var c=[];w&&(c.push("<li><a id='{0}' data-icon='{1}'>{2}</a></li>".format("cmfdCreate","fa-plus",e.folderCreate)),c.push("<li><a id='{0}' data-icon='{1}'>{2}</a></li>".format("cmfdCut","fa-scissors",e.itemCut)),c.push("<li><a id='{0}' data-icon='{1}'>{2}</a></li>".format("cmfdPaste","fa-paste",e.itemPaste)),c.push("<li><a id='{0}' data-icon='{1}'>{2}</a></li>".format("cmfdRename","fa-edit",e.itemRename)),c.push("<li><a id='{0}' data-icon='{1}'>{2}</a></li>".format("cmfdDelete","fa-trash",
e.itemDelete)));a&&(c.push("<li><a id='{0}' data-icon='{1}'>{2}</a></li>".format("cmfdSynch","fa-refresh",e.folderSynchronize)),c.push("<li><a id='{0}' data-icon='{1}'>{2}</a></li>".format("cmfdSynchRecurse","fa-refresh",e.folderSynchronizeRecurse)));r.append(c);r.on("click","li a",U);r.puicontextmenu({target:m})}function S(a){var c=n.data;switch(a.currentTarget.id){case "cmfSelectAll":f.puidatatable("selectAllRows");break;case "cmfCut":a=f.puidatatable("getSelection");l=new g(c.path,q(a),!0);break;
case "cmfCopy":a=f.puidatatable("getSelection");l=new g(c.path,q(a));break;case "cmfPaste":l.path!=c.path?(l.toPath=c.path,p("PasteFiles",l).done(function(a,c,b){l=null;m.puitree("selectNode",n.node)}).fail(function(a,c,b){k(b,a.responseText)})):(D.text(e.cantPaste),A.dialog("open"));break;case "cmfRename":a=f.puidatatable("getContextMenuSelection");var b=new g(c.path,q(a)),u=b.files[0];B(e.renameFileTitle,u).then(function(a){a!=u&&(b.toPath=a,p("Rename",b).done(function(a,c,b){m.puitree("selectNode",
n.node)}).fail(function(a,c,b){k(b,a.responseText)}))});break;case "cmfDelete":I(e.deleteFilesMessage).then(function(){var a=f.puidatatable("getSelection"),b=q(a),a=new g(c.path,b);p("Delete",a).done(function(a,c,t){a=f.puidatatable("option","datasource");a=d.grep(a,function(a,c){return-1==d.inArray(a.name,b)});f.puidatatable("option","datasource",a)}).fail(function(a,c,b){k(b,a.responseText)})});break;case "cmfOpen":a=f.puidatatable("getContextMenuSelection");b=new g(c.path,q(a));J(b);break;case "cmfDownload":a=
f.puidatatable("getContextMenuSelection");b=new g(c.path,q(a),!0);z("DownloadURL",b).done(function(a,c,b){dnn.dom.navigate(a)}).fail(function(a,c,b){k(b,a.responseText)});break;case "cmfClipboard":a=f.puidatatable("getContextMenuSelection");b=new g(c.path,q(a));z("DownloadURL",b).done(function(a,c,b){0<a.length&"/"!=a[0]&&(a="/"+a);a=location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")+a;if(window.clipboardData&&window.clipboardData.setData)clipboardData.setData("Text",a);
else if(document.queryCommandSupported&&document.queryCommandSupported("copy")){c=document.createElement("textarea");c.textContent=a;c.style.position="fixed";document.body.appendChild(c);c.select();try{document.execCommand("copy")}catch(d){console.warn(e.clipboardFailed,d)}finally{document.body.removeChild(c)}}}).fail(function(a,c,b){k(b,a.responseText)});break;case "cmfPack":B(e.packNameTitle,"packedfiles").then(function(a){var b=f.puidatatable("getSelection");a=new g(c.path,q(b),!1,a);p("Pack",
a).done(function(a,c,b){m.puitree("selectNode",n.node)}).fail(function(a,c,b){k(b,a.responseText)})});break;case "cmfUnpack":a=f.puidatatable("getContextMenuSelection"),b=new g(c.path,q(a)),p("Unpack",b).done(function(a,c,b){m.puitree("selectNode",n.node)}).fail(function(a,c,b){k(b,a.responseText)})}}function U(a){var c=n.data;switch(a.currentTarget.id){case "cmfdCreate":B(e.createFolderTitle,"").then(function(a){a=new g(c.path,null,!1,a);p("CreateFolder",a).done(function(a,c,b){m.puitree("refresh")}).fail(function(a,
c,b){k(b,a.responseText)})});break;case "cmfdCut":l=new g(c.path);break;case "cmfdPaste":l.toPath=c.path;p("MoveFolder",l).done(function(a,c,b){l=null;m.puitree("refresh")}).fail(function(a,c,b){k(b,a.responseText)});break;case "cmfdRename":var b=V(c.path);B(e.renameFolderTitle,b).then(function(a){if(a!=b){var d=new g(c.path,null,!1,a);p("Rename",d).done(function(b,d,e){c.path=c.path.replace(/([^\/]+)\/$/g,a+"/");n.node.data("puidata",c);n.node.find("span .ui-treenode-label").text(a)}).fail(function(a,
c,b){k(b,a.responseText)})}});break;case "cmfdDelete":I(e.deleteFolderMessage).then(function(){var a=new g(c.path);p("Delete",a).done(function(a,c,b){m.puitree("refresh")}).fail(function(a,c,b){k(b,a.responseText)})});break;case "cmfdSynch":a=new g(c.path);var u=y(d("#documentExplorer"));p("Synchronize",a).done(function(a,c,b){m.puitree("refresh")}).fail(function(a,c,b){k(b,a.responseText)}).complete(function(){u.remove()});break;case "cmfdSynchRecurse":a=new g(c.path,null,!0),u=y(d("#documentExplorer")),
p("Synchronize",a).done(function(a,c,b){m.puitree("refresh")}).fail(function(a,c,b){k(b,a.responseText)}).complete(function(){u.remove()})}}function J(a){z("DownloadURL",a).done(function(a,b,d){dnn.dom.navigate(a,"_new")}).fail(function(a,b,d){k(d,a.responseText)})}function W(a){a=n.data;var c=f.puidatatable("getSelection");a=new g(a.path,q(c));J(a)}function V(a){if(!a||0==a.length)return"";var c="",b=a.length-1;"/"==a.charAt(b)&&(c=a.substr(0,b));b=c.lastIndexOf("/");-1!=b&&(c=c.substr(b-1));return c}
function X(a,c,b){n=c;(a=n.data.canManage)?(a=a&&null!=l&&0==l.files.length,r.find("li a.ui-state-disabled").each(function(){d(this).removeClass("ui-state-disabled")}),a||r.find("#cmfdPaste").addClass("ui-state-disabled")):r.find("li a").each(function(){d(this).addClass("ui-state-disabled")});N(c.data.path)}function Y(a,c){var b=n.data.canManage,e=b&&null!=l&&0<l.files.length;if(c.name===L)h.find("li a").each(function(){d(this).addClass("ui-state-disabled")}),e&&h.find("#cmfPaste").removeClass("ui-state-disabled");
else{var g=f.puidatatable("getSelection").length,k=1==g&&"zip"==c.extension;h.find("li a.ui-state-disabled").each(function(){d(this).removeClass("ui-state-disabled")});w&&(e||h.find("#cmfPaste").addClass("ui-state-disabled"),b?k||h.find("#cmfUnpack").addClass("ui-state-disabled"):(h.find("#cmfSelectAll").addClass("ui-state-disabled"),h.find("#cmfCut").addClass("ui-state-disabled"),h.find("#cmfRename").addClass("ui-state-disabled"),h.find("#cmfDelete").addClass("ui-state-disabled"),h.find("#cmfPack").addClass("ui-state-disabled"),
h.find("#cmfUnpack").addClass("ui-state-disabled")));1<g&&(h.find("#cmfRename").addClass("ui-state-disabled"),h.find("#cmfOpen").addClass("ui-state-disabled"),h.find("#cmfDownload").addClass("ui-state-disabled"),h.find("#cmfClipboard").addClass("ui-state-disabled"))}}function Z(a){e=a.resources;H=e.sizes.split(",");F=a.showIcon;w=a.fileManagement;G=a.resetFilters;A=d("#deDialogMessage");D=d("#deDialogMessage > #message");A.dialog({autoOpen:!1,modal:!0,closeOnEscape:!0,minWidth:350,dialogClass:"dnnFormPopup",
title:e.errorTitle,buttons:[{text:e.dialogOk,click:function(){d(this).dialog("close")}}]});f=d("#deFiles");f.puidatatable({paginator:{rows:a.rows},columns:a.columns,draggableColumns:!0,resizableColumns:!0,selectionMode:"multiple",rowSelectContextMenu:Y,datasource:[],emptyMessage:e.noFiles});if(a.openOnDblclick)f.on("dblclick",".ui-datatable-data tr",W);h=d("#cmFiles");R();m=d("#deFolders");m.puitree({animate:!0,lazy:!0,selectionMode:"single",nodeSelect:X,nodes:M,icons:{def:{expanded:"fa-folder-open",
collapsed:"fa-folder"}}});r=d("#cmFolders");w?T(a.synchronizeFolder):r.remove()}var v={},x=null,e=null,H=null,F=!1,w=!1,C=!1,G=!1,A=null,D=null,m=null,r=null,f=null,h=null,n=null,l=null;K.init=function(a){v=a;x=v.getServiceRoot("TidyModules/DocumentExplorer")+"Services/{0}/";String.prototype.format||(String.prototype.format=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(b,d){return"undefined"!=typeof a[d]?a[d]:b})});d.extend(d.ui.dialog.prototype.options,{create:function(){var a=
d(this);a.parent().find(".ui-dialog-buttonpane button:first").focus();a.keypress(function(b){if(b.keyCode==d.ui.keyCode.ENTER)return a.parent().find(".ui-dialog-buttonpane button:first").click(),!1})}});d.widget("primeui.puitree",d.primeui.puitree,{refresh:function(){this.rootContainer.empty();this.options.selectionMode&&(this.selection=[]);"array"===d.type(this.options.nodes)?this._renderNodes(this.options.nodes,this.rootContainer):"function"===d.type(this.options.nodes)&&this.options.nodes.call(this,
{},this._initData)}});d.widget("primeui.puidatatable",d.primeui.puidatatable,{selectAllRows:function(){this.options.selectionMode&&(this.selection=this.data,this.paginate())}});z("Options").done(function(a,b,d){b=a.columns;for(d=0;d<b.length;d++)switch(b[d].filter&&!C&&(C=!0),b[d].field){case "name":b[d].content=a.showIcon?O:null;break;case "size":b[d].content=P;break;case "modified":b[d].content=Q}Z(a)}).fail(function(a,b,d){alert("{0}: {1}".format(b,d))})}})(window.tm_de=window.tm_de||{},jQuery);