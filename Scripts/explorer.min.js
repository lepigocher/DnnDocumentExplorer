(function(A,d,B){function f(a,c,b,d){this.path=a;this.files=null!=c?c instanceof Array?c:[c]:[];this.flag="boolean"===typeof b?b:!1;this.toPath=d}function h(a){var c=[];if(a instanceof Array)for(var b=0;b<a.length;b++)c.push(a[b].name);else c.push(a.name);return c}function r(a){var c=d("<div class='spinner'><i class='fa fa-spinner fa-pulse fa-3x fa-fw'></i><span class='sr-only'>"+e.loading+"</span></div>"),b=a.outerHeight();0==b&&a.children().each(function(){var a=d(this).outerHeight();a>b&&(b=a)});
c.find("i").css("margin-top",b/2-20+"px");c.height(b);c.width(a.width());c.prependTo(a);return c}function C(a,c){var b="",e=r(deFolders);a.data&&null!=a.data.path&&(b=a.data.path);var l=p.format("Folders"),v=new f(b);d.ajax({type:"GET",url:l,dataType:"json",data:v,context:this,beforeSend:m.setModuleHeaders}).done(function(l,d,v){null!=l&&c.call(this,l,a.node);""==b&&(l=this.rootContainer.find(".ui-treenode-parent:first"),this.selectNode(l))}).fail(function(a,c,b){g(b,a.responseText)}).complete(function(){e.remove()})}
function D(a){var c=r(deFiles),b=p.format("Files");a=new f(a,null,w);d.ajax({type:"GET",url:b,dataType:"json",data:a,context:this,beforeSend:m.setModuleHeaders}).done(function(a,c,b){deFiles.puidatatable("option","datasource",a);hasFilter&&(resetFilters&&deFiles.find(".ui-column-filter").each(function(){d(this).val("")}),deFiles.puidatatable("filter"))}).fail(function(a,c,b){g(b,a.responseText)}).complete(function(){c.remove()})}function t(a,c){return d.ajax({type:"GET",url:p.format(a),dataType:"json",
data:c,beforeSend:m.setModuleHeaders})}function k(a,c){return d.ajax({type:"POST",url:p.format(a),dataType:"json",data:c,beforeSend:m.setModuleHeaders})}function E(a,c){return"{0} {1}".format(a.icon,a.name)}function F(a,c){var b=a.size;if(0==b)return lr.ZeroByte;var d=parseInt(Math.floor(Math.log(b)/Math.log(1024)));return Math.round(b/Math.pow(1024,d),2)+" "+x[d]}function G(a){a=new Date(a.modified);return a.toLocaleDateString()+" "+a.toLocaleTimeString()}function g(a,c){var b="{0}: {1}".format(a,
c);dlgMessage.text(b);dlgWindow.dialog("open")}function y(a,c){var b=d.Deferred();d("<div></div>").html(a).dialog({modal:!0,minWidth:350,title:e.confirmTitle,dialogClass:"dnnFormPopup",buttons:[{text:e.dialogOk,click:function(){b.resolve(c);d(this).dialog("close")}},{text:e.dialogCancel,click:function(){b.reject();d(this).dialog("close")}}],close:function(){d(this).dialog("destroy").remove()}});return b.promise()}function u(a,c){var b=d.Deferred();d("<div><label for='txtItemName'>"+e.itemName+"&nbsp;</label><input type='text' name='txtItemName' id='txtItemName' class='ui-inputtext ui-widget-content ui-corner-all' value='"+
c+"'></div>").dialog({modal:!0,minWidth:350,title:a,dialogClass:"dnnFormPopup",buttons:[{text:e.dialogOk,click:function(){var a=d(this).find("#txtItemName").val().trim();""!=a?b.resolve(a):b.reject();d(this).dialog("close")}},{text:e.dialogCancel,click:function(){b.reject();d(this).dialog("close")}}],close:function(){d(this).dialog("destroy").remove()}});return b.promise()}function H(){var a=[];q&&(a.push(itemTmpl.format("cmfSelectAll","fa-hand-lizard-o",e.itemSelectAll)),a.push(itemTmpl.format("cmfCut",
"fa-scissors",e.itemCut)),a.push(itemTmpl.format("cmfCopy","fa-copy",e.itemCopy)),a.push(itemTmpl.format("cmfPaste","fa-paste",e.itemPaste)),a.push(itemTmpl.format("cmfRename","fa-edit",e.itemRename)),a.push(itemTmpl.format("cmfDelete","fa-trash",e.itemDelete)));imagePreview&&a.push(itemTmpl.format("cmfPreview","fa-eye",e.imagePreview));a.push(itemTmpl.format("cmfOpen","fa-external-link",e.fileOpen));a.push(itemTmpl.format("cmfDownload","fa-download",e.fileDownload));a.push(itemTmpl.format("cmfClipboard",
"fa-link",e.fileClipboard));q&&(a.push(itemTmpl.format("cmfPack","fa-compress",e.filePack)),a.push(itemTmpl.format("cmfUnpack","fa-expand",e.fileUnpack)));cmFiles.append(a);cmFiles.on("click","li a",I);cmFiles.puicontextmenu({target:deFiles})}function J(a){var c=[];q&&(c.push(itemTmpl.format("cmfdCreate","fa-plus",e.folderCreate)),c.push(itemTmpl.format("cmfdCut","fa-scissors",e.itemCut)),c.push(itemTmpl.format("cmfdPaste","fa-paste",e.itemPaste)),c.push(itemTmpl.format("cmfdRename","fa-edit",e.itemRename)),
c.push(itemTmpl.format("cmfdDelete","fa-trash",e.itemDelete)));a&&(c.push(itemTmpl.format("cmfdSynch","fa-refresh",e.folderSynchronize)),c.push(itemTmpl.format("cmfdSynchRecurse","fa-refresh",e.folderSynchronizeRecurse)));cmFolders.append(c);cmFolders.on("click","li a",K);cmFolders.puicontextmenu({target:deFolders})}function L(a){return"bmp"==a||"jpg"==a||"png"==a||"gif"==a?!0:!1}function I(a){var c=selectedNode.data;switch(a.currentTarget.id){case "cmfSelectAll":deFiles.puidatatable("selectAllRows");
break;case "cmfCut":a=deFiles.puidatatable("getSelection");command=new f(c.path,h(a),!0);break;case "cmfCopy":a=deFiles.puidatatable("getSelection");command=new f(c.path,h(a));break;case "cmfPaste":command.path!=c.path?(command.toPath=c.path,k("PasteFiles",command).done(function(a,c,b){command=null;deFolders.puitree("selectNode",selectedNode.node)}).fail(function(a,c,b){g(b,a.responseText)})):(dlgMessage.text(e.cantPaste),dlgWindow.dialog("open"));break;case "cmfRename":a=deFiles.puidatatable("getContextMenuSelection");
var b=new f(c.path,h(a)),n=b.files[0];u(e.renameFileTitle,n).then(function(a){a!=n&&(b.toPath=a,k("Rename",b).done(function(a,c,b){deFolders.puitree("selectNode",selectedNode.node)}).fail(function(a,c,b){g(b,a.responseText)}))});break;case "cmfDelete":y(e.deleteFilesMessage).then(function(){var a=deFiles.puidatatable("getSelection"),b=h(a),a=new f(c.path,b);k("Delete",a).done(function(a,c,l){a=deFiles.puidatatable("option","datasource");a=d.grep(a,function(a,c){return-1==d.inArray(a.name,b)});deFiles.puidatatable("option",
"datasource",a)}).fail(function(a,c,b){g(b,a.responseText)})});break;case "cmfPreview":a=deFiles.puidatatable("getContextMenuSelection");b=new f(c.path,h(a));d.ajax({type:"GET",url:p.format("Thumbnail"),data:b,beforeSend:m.setModuleHeaders}).done(function(a,c,b){d("<div><img src='"+a+"' /></div>").dialog({modal:!0,width:"auto",title:e.imagePreviewTitle,dialogClass:"dnnFormPopup",buttons:[{text:e.dialogClose,click:function(){d(this).dialog("close")}}],close:function(){d(this).dialog("destroy").remove()}})}).fail(function(a,
c,b){g(b,a.responseText)});break;case "cmfOpen":a=deFiles.puidatatable("getContextMenuSelection");b=new f(c.path,h(a));z(b);break;case "cmfDownload":a=deFiles.puidatatable("getContextMenuSelection");b=new f(c.path,h(a),!0);t("DownloadURL",b).done(function(a,c,b){dnn.dom.navigate(a)}).fail(function(a,c,b){g(b,a.responseText)});break;case "cmfClipboard":a=deFiles.puidatatable("getContextMenuSelection");b=new f(c.path,h(a));t("DownloadURL",b).done(function(a,c,b){0<a.length&"/"!=a[0]&&(a="/"+a);a=location.protocol+
"//"+location.hostname+(location.port?":"+location.port:"")+a;if(window.clipboardData&&window.clipboardData.setData)clipboardData.setData("Text",a);else if(document.queryCommandSupported&&document.queryCommandSupported("copy")){c=document.createElement("textarea");c.textContent=a;c.style.position="fixed";document.body.appendChild(c);c.select();try{document.execCommand("copy")}catch(d){console.warn(e.clipboardFailed,d)}finally{document.body.removeChild(c)}}}).fail(function(a,c,b){g(b,a.responseText)});
break;case "cmfPack":u(e.packNameTitle,"packedfiles").then(function(a){var b=deFiles.puidatatable("getSelection");a=new f(c.path,h(b),!1,a);k("Pack",a).done(function(a,c,b){deFolders.puitree("selectNode",selectedNode.node)}).fail(function(a,c,b){g(b,a.responseText)})});break;case "cmfUnpack":a=deFiles.puidatatable("getContextMenuSelection"),b=new f(c.path,h(a)),k("Unpack",b).done(function(a,c,b){deFolders.puitree("selectNode",selectedNode.node)}).fail(function(a,c,b){g(b,a.responseText)})}}function K(a){var c=
selectedNode.data;switch(a.currentTarget.id){case "cmfdCreate":u(e.createFolderTitle,"").then(function(a){a=new f(c.path,null,!1,a);k("CreateFolder",a).done(function(a,c,b){deFolders.puitree("refresh")}).fail(function(a,c,b){g(b,a.responseText)})});break;case "cmfdCut":command=new f(c.path);break;case "cmfdPaste":command.toPath=c.path;k("MoveFolder",command).done(function(a,c,b){command=null;deFolders.puitree("refresh")}).fail(function(a,c,b){g(b,a.responseText)});break;case "cmfdRename":var b=M(c.path);
u(e.renameFolderTitle,b).then(function(a){if(a!=b){var d=new f(c.path,null,!1,a);k("Rename",d).done(function(b,d,e){c.path=c.path.replace(/([^\/]+)\/$/g,a+"/");selectedNode.node.data("puidata",c);selectedNode.node.find("span .ui-treenode-label").text(a)}).fail(function(a,c,b){g(b,a.responseText)})}});break;case "cmfdDelete":y(e.deleteFolderMessage).then(function(){var a=new f(c.path);k("Delete",a).done(function(a,c,b){deFolders.puitree("refresh")}).fail(function(a,c,b){g(b,a.responseText)})});break;
case "cmfdSynch":a=new f(c.path);var n=r(d("#documentExplorer"));k("Synchronize",a).done(function(a,c,b){deFolders.puitree("refresh")}).fail(function(a,c,b){g(b,a.responseText)}).complete(function(){n.remove()});break;case "cmfdSynchRecurse":a=new f(c.path,null,!0),n=r(d("#documentExplorer")),k("Synchronize",a).done(function(a,c,b){deFolders.puitree("refresh")}).fail(function(a,c,b){g(b,a.responseText)}).complete(function(){n.remove()})}}function z(a){t("DownloadURL",a).done(function(a,b,d){dnn.dom.navigate(a,
"_new")}).fail(function(a,b,d){g(d,a.responseText)})}function N(a){a=selectedNode.data;var c=deFiles.puidatatable("getSelection");a=new f(a.path,h(c));z(a)}function M(a){if(!a||0==a.length)return"";var c="",b=a.length-1;"/"==a.charAt(b)&&(c=a.substr(0,b));b=c.lastIndexOf("/");-1!=b&&(c=c.substr(b-1));return c}function O(a,c,b){selectedNode=c;(a=selectedNode.data.canManage)?(a=a&&null!=command&&0==command.files.length,cmFolders.find("li a.ui-state-disabled").each(function(){d(this).removeClass("ui-state-disabled")}),
a||cmFolders.find("#cmfdPaste").addClass("ui-state-disabled")):cmFolders.find("li a").each(function(){d(this).addClass("ui-state-disabled")});D(c.data.path)}function P(a,c){var b=selectedNode.data.canManage,e=b&&null!=command&&0<command.files.length;if(c.name===B)cmFiles.find("li a").each(function(){d(this).addClass("ui-state-disabled")}),e&&cmFiles.find("#cmfPaste").removeClass("ui-state-disabled");else{var f=deFiles.puidatatable("getSelection").length,g=1==f&&"zip"==c.extension;cmFiles.find("li a.ui-state-disabled").each(function(){d(this).removeClass("ui-state-disabled")});
q&&(e||cmFiles.find("#cmfPaste").addClass("ui-state-disabled"),b?g||cmFiles.find("#cmfUnpack").addClass("ui-state-disabled"):(cmFiles.find("#cmfSelectAll").addClass("ui-state-disabled"),cmFiles.find("#cmfCut").addClass("ui-state-disabled"),cmFiles.find("#cmfRename").addClass("ui-state-disabled"),cmFiles.find("#cmfDelete").addClass("ui-state-disabled"),cmFiles.find("#cmfPack").addClass("ui-state-disabled"),cmFiles.find("#cmfUnpack").addClass("ui-state-disabled")));1<f?(cmFiles.find("#cmfRename").addClass("ui-state-disabled"),
cmFiles.find("#cmfPreview").addClass("ui-state-disabled"),cmFiles.find("#cmfOpen").addClass("ui-state-disabled"),cmFiles.find("#cmfDownload").addClass("ui-state-disabled"),cmFiles.find("#cmfClipboard").addClass("ui-state-disabled")):L(c.extension)||cmFiles.find("#cmfPreview").addClass("ui-state-disabled")}}function Q(a){e=a.resources;x=e.sizes.split(",");w=a.showIcon;q=a.fileManagement;imagePreview=a.imagePreview;resetFilters=a.resetFilters;dlgWindow=d("#deDialogMessage");dlgMessage=d("#deDialogMessage > #message");
dlgWindow.dialog({autoOpen:!1,modal:!0,closeOnEscape:!0,minWidth:350,dialogClass:"dnnFormPopup",title:e.errorTitle,buttons:[{text:e.dialogOk,click:function(){d(this).dialog("close")}}]});deFiles=d("#deFiles");deFiles.puidatatable({paginator:{rows:a.rows},columns:a.columns,draggableColumns:!0,resizableColumns:!0,selectionMode:"multiple",rowSelectContextMenu:P,datasource:[],emptyMessage:e.noFiles});if(a.openOnDblclick)deFiles.on("dblclick",".ui-datatable-data tr",N);cmFiles=d("#cmFiles");H();deFolders=
d("#deFolders");deFolders.puitree({animate:!0,lazy:!0,selectionMode:"single",nodeSelect:O,nodes:C,icons:{def:{expanded:"fa-folder-open",collapsed:"fa-folder"}}});cmFolders=d("#cmFolders");q?J(a.synchronizeFolder):cmFolders.remove()}var m={},p=null,e=null,x=null,w=!1,q=!1;resetFilters=hasFilter=imagePreview=!1;command=selectedNode=cmFiles=deFiles=cmFolders=deFolders=dlgMessage=dlgWindow=null;itemTmpl="<li><a id='{0}' data-icon='{1}'>{2}</a></li>";A.init=function(a){m=a;p=m.getServiceRoot("TidyModules/DocumentExplorer")+
"Services/{0}/";String.prototype.format||(String.prototype.format=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(b,d){return"undefined"!=typeof a[d]?a[d]:b})});d.extend(d.ui.dialog.prototype.options,{create:function(){var a=d(this);a.parent().find(".ui-dialog-buttonpane button:first").focus();a.keypress(function(b){if(b.keyCode==d.ui.keyCode.ENTER)return a.parent().find(".ui-dialog-buttonpane button:first").click(),!1})}});d.widget("primeui.puitree",d.primeui.puitree,{refresh:function(){this.rootContainer.empty();
this.options.selectionMode&&(this.selection=[]);"array"===d.type(this.options.nodes)?this._renderNodes(this.options.nodes,this.rootContainer):"function"===d.type(this.options.nodes)&&this.options.nodes.call(this,{},this._initData)}});d.widget("primeui.puidatatable",d.primeui.puidatatable,{selectAllRows:function(){this.options.selectionMode&&(this.selection=this.data,this.paginate())}});t("Options").done(function(a,b,d){b=a.columns;for(d=0;d<b.length;d++)switch(b[d].filter&&!hasFilter&&(hasFilter=
!0),b[d].field){case "name":b[d].content=a.showIcon?E:null;break;case "size":b[d].content=F;break;case "modified":b[d].content=G}Q(a)}).fail(function(a,b,d){alert("{0}: {1}".format(b,d))})}})(window.tm_de=window.tm_de||{},jQuery);